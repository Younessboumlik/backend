stages:
  - test
  - build
  - e2e-test
  - deploy

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

cache:
  paths:
    - .m2/repository/
    - target/

# ============================================
# NOUVEAU JOB SELENIUM SEULEMENT ✅
# ============================================
selenium-tests:
  stage: e2e-test
  image: maven:3.9-eclipse-temurin-17
  services:
    - name: mysql:8.0
      alias: mysql
    - name: selenium/standalone-chrome:latest
      alias: selenium
  variables:
    MYSQL_ROOT_PASSWORD: rootpassword
    MYSQL_DATABASE: myshopdb_test
    MYSQL_USER: testuser
    MYSQL_PASSWORD: testpassword
    SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/myshopdb_test
    SPRING_DATASOURCE_USERNAME: testuser
    SPRING_DATASOURCE_PASSWORD: testpassword
    SELENIUM_REMOTE_URL: http://selenium:4444/wd/hub
    APP_URL: http://localhost:8080
    CI: "true"
  before_script:
    - echo "Installing dependencies..."
    - apt-get update && apt-get install -y default-mysql-client curl
    - echo "Waiting for MySQL..."
    - |
      until mysqladmin ping -h mysql -u testuser -ptestpassword --silent; do
        echo "MySQL not ready, waiting..."
        sleep 2
      done
    - echo "MySQL is ready!"
    - echo "Starting Spring Boot application..."
    - nohup mvn spring-boot:run -Dspring.profiles.active=test > app.log 2>&1 &
    - APP_PID=$!
    - echo "Application PID: $APP_PID"
    - echo "Waiting for application to start..."
    - |
      for i in {1..60}; do
        if curl -s http://localhost:8080/actuator/health > /dev/null 2>&1; then
          echo "✅ Application is ready!"
          break
        fi
        echo "Attempt $i/60: Application not ready..."
        sleep 3
      done
    - echo "Checking Selenium Grid..."
    - |
      until curl -s http://selenium:4444/wd/hub/status > /dev/null 2>&1; do
        echo "Selenium not ready, waiting..."
        sleep 2
      done
    - echo "✅ Selenium Grid is ready!"
  script:
    - echo "Running Selenium E2E tests..."
    - mvn test -Dtest=TestProjectTest -Dspring.profiles.active=test
  after_script:
    - echo "Stopping application..."
    - kill $APP_PID 2>/dev/null || true
    - echo "Application logs:"
    - cat app.log || true
  artifacts:
    when: always
    reports:
      junit:
        - target/surefire-reports/TEST-*.xml
    paths:
      - target/surefire-reports/
      - target/screenshots/
      - app.log
    expire_in: 1 week
  allow_failure: true
  only:
    - main
    - develop